<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="Rccar State" content="width=device-width, initial-scale=1.0">
    <title>RCCAR State</title>
    <style type="text/css">
        .parent{
            width: 90%;
            margin: 10px auto;
            display: flex;
        }
        .child{
            border: 1px solid green;
            flex:1;
            margin: 0px 5%;
            width:20%;
            box-sizing: border-box;
        }
    </style>
    <!--Paho-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
    <!--Font Awesome-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css" integrity="sha512-SzlrxWUlpfuzQ+pcUCosxcglQRNAq/DZjVsC0lE40xsADsfeQoEypE+enwcOiGjk/bSuGGKHEyjSoQ1zVisanQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body>
    <div class = "parent">
        <div class = "child">
                <div style = "padding : 3%; font: 1.3em bold; text-align:center">주행거리 </div>
                <div class="fa-solid fa-car-side"style = 'margin : 1% 15%; font-size:5em'></div>
                <div style = "font: 1.3em bold;  text-align:center">
                    <span id = 'distance'>dd</span>km
                </div>
        </div>
        <div class = "child">
                <div style = "padding : 3%; font: 1.3em bold; text-align:center">시동여부 </div>
                <div class="fa-solid fa-power-off" style = 'font-size:5em; margin : 1% 15%;'></div>
                <div id ='boot' style = "font: 1.3em bold;  text-align:center">OFF</div>
        </div>
        <div class = "child">
                <div style = "padding : 3%; font: 1.3em bold; text-align:center">장애물 감지 횟수 </div>
                <div class="fa-solid fa-object-ungroup" style = 'margin : 1% 15%; font-size:5em'></div>
                <div style = "font: 1.3em bold;  text-align:center">
                    <span id = 'obstacle'></span>회
                </div>
        </div>
        <div class = "child">
                <div style = "padding : 3%; font: 1.3em bold; text-align:center">충돌 감지 횟수 </div>
                <div class="fa-solid fa-car-burst" style = 'margin : 1% 15%; font-size:5em'></div>
                <div style = "font: 1.3em bold;  text-align:center">
                    <span id = 'crash'></span>회
                </div>
        </div>
    </div>

    <!-- ==============Script=================-->
    <script>
        let states = {
            distance : document.getElementById('distance'), 
            boot : document.getElementById('boot'), 
            obstacle : document.getElementById('obstacle'),
            crash : document.getElementById('crash')
        }

        /* MQTT 연결 */
        const BROKER_ID = 'localhost'
        const BROKER_PORT = 1883;
        const CLIENT_ID = 'client_id - ' + parseInt(Math.random() * 100);
        const SUBSCRIBE_TOPIC = "rccar/state/response/#";

        client = new Paho.MQTT.Client(BROKER_ID, BROKER_PORT, CLIENT_ID);
        console.log(BROKER_ID, BROKER_PORT, CLIENT_ID);

        // publish & sub //
        client.onConnectionLost = onConnectionLost;
        client.onMessageArrived = onMessageArrived;

        client.connect({
            onSuccess : onConnect, 
            onFailure : onFailure
        });

        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                console.log('onConnectLost : ' + responseObject.errorMessage);
            }
        }

        function onMessageArrived(message) {
            let parts = message.destinationName.split('/');

            console.log("topic : " + message.destinationName);
            console.log("message : " + message.payloadString);

            if (states[parts.at(-1)]) states[parts.at(-1)].innerText = message.payloadString;
            else console.log("잘못된 센서 카테고리입니다 . . .", parts.at(-1));
        }

        function onFailure() {
            console.log("Please enter host and port again . . ");
        }

        function onConnect() {
            console.log("onConnect!")
            const topic = "rccar/state/boot";
            const message = new Paho.MQTT.Message("bootState");
    
            message.destinationName = topic;
            message.qos = 1;
    
            client.send(message);
            client.subscribe(SUBSCRIBE_TOPIC);
        }
    </script>
</body>
</html>